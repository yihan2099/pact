#!/bin/sh
#
# Pre-commit hook: Prevent accidental commit of secrets and .env files
#

# Block .env files (except .env.example)
ENV_FILES=$(git diff --cached --name-only --diff-filter=ACR | grep -E '\.env($|\.)' | grep -v '\.env\.example' || true)

if [ -n "$ENV_FILES" ]; then
  echo "ERROR: Blocked commit of .env file(s):"
  echo "$ENV_FILES"
  echo ""
  echo "These files may contain secrets. If intentional, use --no-verify to bypass."
  exit 1
fi

# Detect common secret patterns in staged diffs
SECRETS_FOUND=$(git diff --cached -U0 --diff-filter=ACM | grep -E '^\+.*(PRIVATE_KEY|SECRET_KEY|API_KEY|API_SECRET|ACCESS_TOKEN|AUTH_TOKEN|DATABASE_URL|SUPABASE_SERVICE_ROLE_KEY|PINATA_JWT)\s*=' | grep -v '^\+.*#' | grep -v '\.example' || true)

if [ -n "$SECRETS_FOUND" ]; then
  echo "WARNING: Possible secrets detected in staged changes:"
  echo "$SECRETS_FOUND"
  echo ""
  echo "Review carefully. If these are not real secrets, use --no-verify to bypass."
  exit 1
fi
